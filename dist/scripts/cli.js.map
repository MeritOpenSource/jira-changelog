{"version":3,"sources":["../../src/cli.js"],"names":["runProgram","commandLineArgs","pkg","require","program","version","option","parseRange","parse","process","argv","gitPath","cwd","args","length","path","resolve","config","jira","Jira","source","SourceControl","release","generateReleaseVersionName","console","log","range","getRangeObject","commitLogs","getCommitLogs","changelog","generate","tmplData","releaseVersions","changelogMessage","entitles","AllHtmlEntities","decode","slack","postToSlack","ticket","updateReleaseTicket","e","error","stack","exit","data","Slack","isEnabled","channel","Error","transformForSlack","Promise","postMessage","err","rangeStr","split","defaultRange","sourceControl","from","to","dateRange","after","before","Object","keys","assign"],"mappings":"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","sourcesContent":["#!/usr/bin/env node\n\n/**\n * The jira-changelog CLI\n */\n\nimport \"core-js/stable\";\nimport \"regenerator-runtime/runtime\";\nimport 'source-map-support/register';\nimport program from 'commander';\nimport path from 'path';\nimport Slack from './Slack';\nimport { AllHtmlEntities } from 'html-entities';\n\nimport { generateTemplateData, renderTemplate } from './template';\nimport {readConfigFile} from './Config';\nimport SourceControl from './SourceControl';\nimport Jira from './Jira';\n\nrunProgram();\n\n/**\n * Parse command line arguments\n */\nfunction commandLineArgs() {\n  const pkg = require('../../package.json');\n  program\n    .version(pkg.version)\n    .option(\n      '-c, --config <filepath>',\n      'Path to the config file.'\n    )\n    .option(\n      '-r, --range <from>...<to>',\n      'git commit range for changelog',\n      parseRange\n    )\n    .option(\n      '-d, --date <date>[...date]',\n      'Only include commits after this date',\n      parseRange\n    )\n    .option(\n      '-s, --slack',\n      'Automatically post changelog to slack (if configured)'\n    )\n    .option(\n      '--release [release]',\n      'Assign a release version to these stories'\n    )\n    .option(\n      '-t, --ticket <ticketId>',\n      'Add the changelog to the description of the specified ticket'\n    )\n    .parse(process.argv);\n}\n\n/**\n * Run the main program\n */\nasync function runProgram() {\n  try {\n    commandLineArgs();\n\n    // Determine the git workspace path\n    let gitPath = process.cwd();\n    if (program.args.length) {\n      gitPath = program.args[0];\n    }\n    gitPath = path.resolve(gitPath);\n\n    const config = readConfigFile(gitPath);\n    const jira = new Jira(config);\n    const source = new SourceControl(config);\n\n    // Release flag used, but no name passed\n    if (program.release === true) {\n      if (typeof config.jira.generateReleaseVersionName !== 'function') {\n        console.log(\"You need to define the jira.generateReleaseVersionName function in your config, if you're not going to pass the release version name in the command.\")\n        return;\n      }\n      program.release = await config.jira.generateReleaseVersionName();\n    }\n\n    // Get logs\n    const range = getRangeObject(config);\n    const commitLogs = await source.getCommitLogs(gitPath, range);\n    const changelog = await jira.generate(commitLogs, program.release);\n\n    // Render template\n    const tmplData = await generateTemplateData(config, changelog, jira.releaseVersions);\n    const changelogMessage = renderTemplate(config, tmplData);\n\n    // Output to console\n    const entitles = new AllHtmlEntities();\n    console.log(entitles.decode(changelogMessage));\n\n    // Post to slack\n    if (program.slack) {\n      await postToSlack(config, tmplData, changelogMessage);\n    }\n\n    // Update release ticket if one is provided\n    if (program.ticket) {\n      await jira.updateReleaseTicket(program.ticket, changelogMessage);\n    }\n  } catch(e) {\n    console.error(e.stack || e);\n    process.exit(1);\n  }\n}\n\n/**\n * Post the changelog to slack\n *\n * @param {Object} config - The configuration object\n * @param {Object} data - The changelog data object.\n * @param {String} changelogMessage - The changelog message\n */\nasync function postToSlack(config, data, changelogMessage) {\n  const slack = new Slack(config);\n\n  if (!slack.isEnabled() || !config.slack.channel) {\n    throw new Error('Error: Slack is not configured.');\n    return;\n  }\n\n  console.log(`\\nPosting changelog message to slack channel: ${config.slack.channel}...`);\n  try {\n\n    // Transform for slack\n    if (typeof config.transformForSlack == 'function') {\n      changelogMessage = await Promise.resolve(config.transformForSlack(changelogMessage, data));\n    }\n\n    // Post to slack\n    await slack.postMessage(changelogMessage, config.slack.channel);\n    console.log('Sent');\n\n  } catch(err) {\n    throw new Error(err);\n  }\n}\n\n/**\n * Convert a range string formatted as \"a...b\" into an array.\n *\n * @param {String} rangeStr - The range string.\n * @return {Array}\n */\nfunction parseRange(rangeStr) {\n  return rangeStr.split(/\\.{3,3}/);\n}\n\n\n/**\n * Construct the range object from the CLI arguments and config\n *\n * @param {Object} config - The config object provided by Config.getConfigForPath\n * @return {Object}\n */\nfunction getRangeObject(config) {\n  const range = {};\n  const defaultRange = (config.sourceControl && config.sourceControl.defaultRange) ? config.sourceControl.defaultRange : {};\n\n  if (program.range && program.range.length) {\n    range.from = program.range[0];\n    range.to = program.range[1];\n  }\n  if (program.dateRange && program.dateRange.length) {\n    range.after = program.dateRange[0];\n    if (program.dateRange.length > 1) {\n      range.before = program.dateRange[1];\n    }\n  }\n\n  // Use default range\n  if (!Object.keys(range).length && Object.keys(defaultRange).length) {\n    Object.assign(range, defaultRange);\n  }\n\n  if (!Object.keys(range).length){\n      throw new Error('No range defined for the changelog.');\n  }\n  return range;\n}\n"],"file":"cli.js"}